<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - UHH Mensa</title>
    <meta name="robots" content="noindex, nofollow">
    <link rel="stylesheet" href="styles.css">
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--bg-3);
            border: var(--bw) solid var(--accent);
            border-radius: var(--br);
        }

        .admin-header h1 {
            color: var(--accent);
            font-family: var(--font-ui);
            letter-spacing: var(--track-tight);
        }

        .access-denied {
            max-width: 600px;
            margin: 100px auto;
            padding: 40px;
            background: var(--bg-3);
            border: var(--bw) solid var(--danger);
            border-radius: var(--br-lg);
            text-align: center;
        }

        .access-denied h1 {
            color: var(--danger);
            font-family: var(--font-ui);
            margin-bottom: 20px;
        }

        .access-denied p {
            color: var(--text);
            font-family: var(--font-ui);
            font-size: var(--size-m);
            margin-bottom: 20px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-3);
            background-image: linear-gradient(to left, rgba(0,0,0,0.4), rgba(0,0,0,0));
            border: var(--bw) solid var(--accent);
            border-radius: var(--br);
            padding: 20px;
            text-align: center;
            transition: var(--t-fast);
        }

        .stat-card:hover {
            background: #4c566a;
            border-color: var(--accent-2);
            box-shadow: var(--shadow-accent);
        }

        .stat-card h3 {
            color: var(--accent-2);
            font-family: var(--font-ui);
            font-size: var(--size-m);
            letter-spacing: var(--track-tight);
            margin-bottom: 10px;
        }

        .stat-card .value {
            color: var(--warm);
            font-family: var(--font-ui);
            font-size: var(--size-xxl);
            font-weight: bold;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: var(--bw) solid var(--accent);
        }

        .tab {
            padding: 12px 24px;
            background: var(--bg-3);
            border: var(--bw) solid var(--accent);
            border-bottom: none;
            cursor: pointer;
            font-family: var(--font-ui);
            font-size: var(--size-m);
            color: var(--text);
            border-radius: var(--br) var(--br) 0 0;
            margin-bottom: calc(-1 * var(--bw));
            transition: var(--t-fast);
        }

        .tab:hover {
            background: #4c566a;
            border-color: var(--accent-2);
            color: var(--accent-2);
        }

        .tab.active {
            background: var(--bg-1);
            color: var(--warm);
            border-bottom: var(--bw) solid var(--bg-1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .photo-card {
            background: var(--bg-3);
            border: var(--bw) solid var(--accent);
            border-radius: var(--br);
            overflow: hidden;
            transition: var(--t-fast);
        }

        .photo-card:hover {
            border-color: var(--accent-2);
            box-shadow: var(--shadow-accent);
        }

        .photo-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .photo-card .info {
            padding: 15px;
        }

        .photo-card .info p {
            margin: 5px 0;
            font-family: var(--font-ui);
            font-size: var(--size-s);
            color: var(--text);
        }

        .photo-card button {
            width: 100%;
            margin-top: 10px;
        }

        .comment-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .comment-item {
            background: var(--bg-3);
            border: var(--bw) solid var(--accent);
            border-radius: var(--br);
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: start;
            gap: 15px;
            transition: var(--t-fast);
        }

        .comment-item:hover {
            border-color: var(--accent-2);
            box-shadow: var(--shadow-accent);
        }

        .comment-item .content {
            flex: 1;
        }

        .comment-item .meta {
            font-family: var(--font-ui);
            font-size: var(--size-xs);
            color: var(--text-gray);
            margin-bottom: 8px;
        }

        .comment-item .text {
            font-family: var(--font-ui);
            font-size: var(--size-m);
            color: var(--text);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text);
            font-family: var(--font-ui);
            font-size: var(--size-l);
        }

        .danger-btn {
            background: linear-gradient(135deg, var(--danger), #c0392b);
            border-color: var(--danger);
            color: #fff;
        }

        .danger-btn:hover {
            background: linear-gradient(135deg, #c0392b, var(--danger));
            box-shadow: 0 0 8px rgba(224, 108, 117, 0.4);
        }
    </style>
</head>
<body>
    <div class="container admin-container">
        <header>
            <h1>[ ADMIN PANEL ]</h1>
            <div id="auth-container" class="auth-container"></div>
        </header>

        <!-- Loading Screen -->
        <div id="loadingScreen" class="loading">
            [ LOADING... ]
        </div>

        <!-- Access Denied Screen -->
        <div id="accessDenied" class="access-denied" style="display: none;">
            <h1>[ ACCESS DENIED ]</h1>
            <p>You do not have administrator privileges.</p>
            <p>Admin access is restricted to authorized @uni-hamburg.de email addresses.</p>
            <button class="auth-btn" onclick="window.location.href='index.html'">[ RETURN TO HOME ]</button>
        </div>

        <!-- Admin Panel -->
        <div id="adminPanel" style="display: none;">
            <div class="admin-header">
                <h1>[ ADMIN DASHBOARD ]</h1>
            </div>

            <!-- Statistics -->
            <div id="statsContainer" class="stats"></div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('photos')">[ PHOTOS ]</button>
                <button class="tab" onclick="switchTab('comments')">[ COMMENTS ]</button>
            </div>

            <!-- Photos Tab -->
            <div id="photosTab" class="tab-content active">
                <div id="photoGrid" class="photo-grid"></div>
            </div>

            <!-- Comments Tab -->
            <div id="commentsTab" class="tab-content">
                <div id="commentList" class="comment-list"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="auth.js"></script>
    <script>
        let isAdmin = false;

        // Wait for auth to initialize
        async function checkAdminAccess() {
            // Wait a bit for auth.js to initialize
            await new Promise(resolve => setTimeout(resolve, 500));

            const user = window.AuthModule?.getUser();

            if (!user) {
                // Not logged in, show access denied
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('accessDenied').style.display = 'block';
                return;
            }

            // Check if user is admin by calling backend
            try {
                const token = await window.AuthModule.getAuthToken();
                console.log('[Admin Check] User email:', user.email);
                console.log('[Admin Check] Has token:', !!token);

                const response = await fetch('/api/admin/check', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();
                console.log('[Admin Check] Response:', data);

                if (data.isAdmin) {
                    isAdmin = true;
                    showAdminPanel();
                } else {
                    console.warn('[Admin Check] Access denied for email:', user.email);
                    document.getElementById('loadingScreen').style.display = 'none';
                    document.getElementById('accessDenied').style.display = 'block';
                }
            } catch (err) {
                console.error('Admin check error:', err);
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('accessDenied').style.display = 'block';
            }
        }

        function showAdminPanel() {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            loadStats();
            loadPhotos();
            loadComments();
        }

        function switchTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(tab + 'Tab').classList.add('active');
        }

        async function getAuthHeaders() {
            const token = await window.AuthModule.getAuthToken();
            return { 'Authorization': `Bearer ${token}` };
        }

        async function loadStats() {
            try {
                const headers = await getAuthHeaders();
                const res = await fetch('/api/admin/stats', { headers });
                const stats = await res.json();

                const container = document.getElementById('statsContainer');
                container.innerHTML = `
                    <div class="stat-card">
                        <h3>[ TOTAL PHOTOS ]</h3>
                        <div class="value">${stats.total_photos || 0}</div>
                    </div>
                    <div class="stat-card">
                        <h3>[ PHOTOS TODAY ]</h3>
                        <div class="value">${stats.photos_today || 0}</div>
                    </div>
                    <div class="stat-card">
                        <h3>[ TOTAL COMMENTS ]</h3>
                        <div class="value">${(stats.total_meal_comments || 0) + (stats.total_photo_comments || 0)}</div>
                    </div>
                    <div class="stat-card">
                        <h3>[ STORAGE USED ]</h3>
                        <div class="value">${stats.storage_mb || 0} MB</div>
                    </div>
                `;
            } catch (err) {
                console.error('Failed to load stats:', err);
            }
        }

        async function loadPhotos() {
            try {
                const headers = await getAuthHeaders();
                const res = await fetch('/api/admin/photos', { headers });
                const data = await res.json();

                const grid = document.getElementById('photoGrid');
                if (!data.photos || data.photos.length === 0) {
                    grid.innerHTML = '<p style="color: var(--text); font-family: var(--font-ui);">[ NO PHOTOS FOUND ]</p>';
                    return;
                }

                grid.innerHTML = data.photos.map(photo => `
                    <div class="photo-card">
                        <img src="${photo.photo_url}" alt="${photo.meal_name || 'Photo'}" />
                        <div class="info">
                            <p><strong>${photo.meal_name || 'Unknown Meal'}</strong></p>
                            <p>${photo.mensa_location || 'Unknown Location'}</p>
                            <p>By: ${photo.author_name || 'Anonymous'}</p>
                            <p>${photo.caption || 'No caption'}</p>
                            <p>${photo.vote_count || 0} likes, ${photo.comment_count || 0} comments</p>
                            <button class="auth-btn danger-btn" onclick="deletePhoto(${photo.id})">[ DELETE ]</button>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Failed to load photos:', err);
            }
        }

        async function loadComments() {
            try {
                const headers = await getAuthHeaders();
                const res = await fetch('/api/admin/comments', { headers });
                const data = await res.json();

                const list = document.getElementById('commentList');
                if (!data.comments || data.comments.length === 0) {
                    list.innerHTML = '<p style="color: var(--text); font-family: var(--font-ui);">[ NO COMMENTS FOUND ]</p>';
                    return;
                }

                list.innerHTML = data.comments.map(comment => `
                    <div class="comment-item">
                        <div class="content">
                            <div class="meta">
                                ${comment.type === 'meal' ? 'MEAL' : 'PHOTO'} COMMENT BY <strong>${comment.author_name || 'Anonymous'}</strong> ON ${comment.ref_name || 'Unknown'}
                            </div>
                            <div class="text">${comment.comment_text}</div>
                        </div>
                        <button class="auth-btn danger-btn" onclick="deleteComment('${comment.type}', ${comment.id})">[ DELETE ]</button>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Failed to load comments:', err);
            }
        }

        async function deletePhoto(photoId) {
            if (!confirm('Delete this photo permanently? This action cannot be undone.')) return;

            try {
                const headers = await getAuthHeaders();
                const res = await fetch(`/api/admin/photos/${photoId}`, {
                    method: 'DELETE',
                    headers
                });
                const data = await res.json();

                if (data.success) {
                    loadPhotos();
                    loadStats();
                } else {
                    alert('Failed to delete photo: ' + (data.error || 'Unknown error'));
                }
            } catch (err) {
                console.error('Delete error:', err);
                alert('Failed to delete photo');
            }
        }

        async function deleteComment(type, commentId) {
            if (!confirm('Delete this comment permanently? This action cannot be undone.')) return;

            try {
                const headers = await getAuthHeaders();
                const res = await fetch(`/api/admin/comments/${type}/${commentId}`, {
                    method: 'DELETE',
                    headers
                });
                const data = await res.json();

                if (data.success) {
                    loadComments();
                    loadStats();
                } else {
                    alert('Failed to delete comment: ' + (data.error || 'Unknown error'));
                }
            } catch (err) {
                console.error('Delete error:', err);
                alert('Failed to delete comment');
            }
        }

        // Listen for auth changes
        document.addEventListener('auth:changed', () => {
            if (!isAdmin) {
                checkAdminAccess();
            }
        });

        // Check access on page load
        checkAdminAccess();
    </script>
</body>
</html>
